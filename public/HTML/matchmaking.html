<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // Retrieve time control from query parameters
  var timeControl = new URLSearchParams(window.location.search).get('time') || 300;

  // Poll the matchmaking API every 3 seconds
  var matchmakingInterval = setInterval(pollMatchmaking, 3000);

  function pollMatchmaking() {
    $.ajax({
      url: "http://18.117.167.197/PHP/check_match.php", // Updated URL using the PHP alias
      method: "GET",
      data: { time: timeControl },
      dataType: "json",
      success: function(response) {
        if (response.matched) {
          clearInterval(matchmakingInterval);
          // Redirect to Game page with game details in query parameters
          window.location.href = "Game.html?gameId=" + response.game_id +
                  "&time=" + timeControl +
                  "&color=" + response.color;
        }
      },
      error: function() {
        console.log("Error contacting matchmaking server");
      }
    });
  }

  // Function to cancel matchmaking and return to MainPage
  function cancelMatchmaking() {
    clearInterval(matchmakingInterval);
    window.location.href = "MainPage.html";
  }

  // Instead of using a non-existent matchmaking.php endpoint,
  // you need to first join the queue by calling join_queue.php.
  // This example assumes youâ€™ve adjusted your flow accordingly.
  // For example, you could call join_queue.php when the page loads.
  $(document).ready(function() {
    $.ajax({
      url: "http://18.117.167.197/PHP/join_queue.php", // Updated URL for join_queue.php
      method: "POST",
      data: JSON.stringify({ timeControl: timeControl }),
      contentType: "application/json",
      dataType: "json",
      success: function(response) {
        console.log("join_queue response:", response);
        if (response.status === "immediate_match") {
          window.location.href = "Game.html?gameId=" + response.game_id +
                  "&time=" + timeControl +
                  "&color=" + response.color;
        } else if (response.status === "queued") {
          // Already polling from the interval above.
        }
      },
      error: function(xhr, status, error) {
        console.error("Error joining queue:", error);
      }
    });
  });
</script>
